package com.leaf.lack.ui

import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.widget.Button
import android.widget.ImageView
import android.widget.TextView
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import com.leaf.lack.R
import okhttp3.*
import okhttp3.MediaType.Companion.toMediaTypeOrNull
import okhttp3.RequestBody.Companion.asRequestBody
import okhttp3.RequestBody.Companion.toRequestBody
import java.io.File
import java.io.FileOutputStream
import java.io.IOException

class ImagePreviewActivity : AppCompatActivity() {

    private lateinit var imageView: ImageView
    private lateinit var analyzeButton: Button
    private lateinit var retakeText: TextView

    // ✅ 서버 BASE URL (ngrok)
    private val BASE_URL = "https://247a7fedc395.ngrok-free.app"

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_image_preview)

        imageView = findViewById(R.id.image_preview)
        analyzeButton = findViewById(R.id.btn_analyze)
        retakeText = findViewById(R.id.tv_retake_photo)

        // ✅ 전달받은 이미지 URI 받아서 미리보기
        val uriString = intent.getStringExtra("image_uri")
        val imageUri = uriString?.let { Uri.parse(it) }

        if (imageUri != null) {
            imageView.setImageURI(imageUri)
        } else {
            Toast.makeText(this, "이미지를 불러올 수 없습니다", Toast.LENGTH_SHORT).show()
            finish() // 오류시 미리보기 화면 종료
            return
        }

        // ✅ 분석 시작 버튼
        analyzeButton.setOnClickListener {
            Toast.makeText(this, "분석을 시작합니다!", Toast.LENGTH_SHORT).show()
            uploadToServer(imageUri)
        }

        // ✅ 다시 촬영하기 버튼
        retakeText.setOnClickListener {
            val intent = Intent(this, CameraCaptureActivity::class.java)
            startActivity(intent)
            finish() // 현재 화면 종료
        }
    }

    /**
     * 앱에서 서버의 /upload 로 Multipart 전송
     */
    private fun uploadToServer(imageUri: Uri) {
        val client = OkHttpClient()

        // contentResolver로 임시 파일 복사 → Multipart 업로드
        val tempFile = createTempFile(suffix = ".jpg", directory = cacheDir).apply {
            outputStream().use { out ->
                contentResolver.openInputStream(imageUri)?.use { input ->
                    input.copyTo(out)
                }
            }
        }

        val mediaType = "image/*".toMediaTypeOrNull()
        val fileBody = tempFile.asRequestBody(mediaType)

        val multipart = MultipartBody.Builder()
            .setType(MultipartBody.FORM)
            .addFormDataPart("file", tempFile.name, fileBody)
            .build()

        val req = Request.Builder()
            .url("$BASE_URL/upload")
            .post(multipart)
            .build()

        client.newCall(req).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {
                runOnUiThread {
                    Toast.makeText(this@ImagePreviewActivity, "업로드 실패: ${e.message}", Toast.LENGTH_LONG).show()
                }
            }

            override fun onResponse(call: Call, response: Response) {
                if (!response.isSuccessful) {
                    runOnUiThread {
                        Toast.makeText(this@ImagePreviewActivity, "서버 응답 실패: ${response.code}", Toast.LENGTH_LONG).show()
                    }
                    return
                }
                // 성공 → 히스토리 페이지로 이동 (최신 결과를 서버에서 그려오도록)
                runOnUiThread {
                    Toast.makeText(this@ImagePreviewActivity, "업로드 성공!", Toast.LENGTH_SHORT).show()
                    startActivity(Intent(this@ImagePreviewActivity, HistoryActivity::class.java))
                }
            }
        })
    }
}
